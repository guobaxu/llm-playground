# 批量测试性能优化指南

## 性能优化方案

### 1. 使用异步并发版本（推荐）

我已经创建了 `async_batch_excel_query.py`，相比原版本有以下优势：

#### 性能提升
- **并发处理**：支持同时处理多个问题（默认10个并发）
- **自适应延迟**：根据API响应时间自动调整请求频率
- **批量处理**：分批处理避免内存占用过大
- **流式响应**：高效处理API的流式返回

#### 速度对比
- **原版本**：串行处理，每个问题1秒延迟，100个问题约需100秒
- **异步版本**：并发处理，自适应延迟，100个问题约需10-20秒

### 2. 使用方法

#### 基本用法
```bash
# 使用异步版本处理Excel文件
python async_batch_excel_query.py input.xlsx

# 指定并发数（建议5-20之间）
python async_batch_excel_query.py input.xlsx -c 15

# 禁用自适应延迟（如果API很稳定）
python async_batch_excel_query.py input.xlsx --no-adaptive-delay
```

#### 高级参数
```bash
python async_batch_excel_query.py input.xlsx \
    -o output.xlsx \                    # 输出文件
    -c 20 \                            # 并发数
    --save-interval 30 \               # 每30个问题保存一次
    -s 0 \                             # 从第1行开始
    -m 100 \                           # 最多处理100行
    --overwrite                        # 直接覆盖源文件
```

### 3. 性能调优建议

#### 并发数设置
- **保守设置**：5-10个并发（适合API限制较严的情况）
- **平衡设置**：10-15个并发（推荐设置）
- **激进设置**：15-25个并发（API性能很好时）

#### 延迟优化
- **启用自适应延迟**：让系统自动调整请求频率
- **监控响应时间**：如果平均响应时间>5秒，减少并发数
- **观察错误率**：如果错误率>5%，增加延迟或减少并发

#### 内存优化
- **分批处理**：默认每批100个问题，避免内存占用过大
- **定期保存**：每50个问题保存一次，防止数据丢失

### 4. 监控和调试

#### 实时监控
```bash
# 查看处理进度和性能统计
python async_batch_excel_query.py input.xlsx -c 10 --save-interval 20
```

输出示例：
```
开始异步处理Excel文件: input.xlsx
最大并发数: 10
自适应延迟: 启用
--------------------------------------------------
成功读取Excel文件，共 1000 行数据
将处理第 1 到第 1000 行
--------------------------------------------------
准备处理 950 个有效问题
处理批次 1: 第 1 到第 100 个问题
第 1 行: 成功 (1.23s)
第 2 行: 成功 (0.98s)
...
已保存进度到: output.xlsx (已处理 50 个问题)
--------------------------------------------------
异步处理完成!
总处理问题数: 950
成功: 945
失败: 5
总耗时: 45.67 秒
平均响应时间: 1.23 秒
平均每问题: 0.048 秒
并发效率: 20.8 问题/秒
```

### 5. 故障排除

#### 常见问题

**问题1：请求超时**
```
解决方案：减少并发数或增加超时时间
python async_batch_excel_query.py input.xlsx -c 5
```

**问题2：API限制**
```
解决方案：启用自适应延迟或手动设置延迟
python async_batch_excel_query.py input.xlsx --no-adaptive-delay
```

**问题3：内存不足**
```
解决方案：减少批次大小或并发数
修改代码中的 batch_size = 50
```

**问题4：网络不稳定**
```
解决方案：增加重试机制或减少并发数
python async_batch_excel_query.py input.xlsx -c 3
```

### 6. 最佳实践

#### 生产环境建议
1. **先小批量测试**：用10-20个问题测试最佳并发数
2. **监控API状态**：观察响应时间和错误率
3. **定期保存**：设置合适的保存间隔（20-50个问题）
4. **备份数据**：处理前备份原始Excel文件

#### 性能优化策略
1. **根据API性能调整**：响应快的API可以用更高并发
2. **分批处理大文件**：超过1000个问题建议分批处理
3. **使用进度保存**：长时间处理必须启用定期保存
4. **监控资源使用**：注意CPU和内存使用情况

### 7. 预期性能提升

| 问题数量 | 原版本耗时 | 异步版本耗时 | 提升倍数 |
|---------|-----------|-------------|---------|
| 100个   | ~100秒    | ~10-15秒    | 6-10倍  |
| 500个   | ~500秒    | ~30-50秒    | 10-16倍 |
| 1000个  | ~1000秒   | ~60-100秒   | 10-16倍 |

*实际性能取决于API响应速度和网络状况
